<!DOCTYPE html>
<html>
Â  <head>
Â  Â  <title>Custom Block Editor</title>
Â  Â  Â  Â  <script src="https://salesforce-marketingcloud.github.io/blocksdk/dist/blocksdk.min.js"></script>
Â  </head>
Â  <body>
Â  Â  <h1>Custom Message Editor</h1>
Â  Â  <input
Â  Â  Â  type="text"
Â  Â  Â  id="customMessage"
Â  Â  Â  placeholder="Enter your custom message"
Â  Â  />
Â  Â  <button id="saveButton">Save Content</button>

Â  Â  <script>
        // ðŸ”‘ FIX A: Ensure initialization runs AFTER the DOM and SDK are loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Initialize the SDK (will now be defined)
            var sdk = new window.sfdc.BlockSDK();
            
            // Helper function to safely extract the JSON from the saved HTML
            function getConfigFromHtml(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const configElement = tempDiv.querySelector('[data-json-config]');
                
                if (configElement) {
                    const jsonString = configElement.getAttribute('data-json-config').replace(/&quot;/g, '"');
                    try {
                        return JSON.parse(jsonString);
                    } catch (e) {
                        console.error('Error parsing JSON from saved content:', e);
                        return null;
                    }
                }
                return null;
            }

            // 2. Define the saveContent function
            function saveContent() {
                var message = document.getElementById("customMessage").value;
                
                var config = { messageText: message };
                // Escape quotes for HTML attribute safety
                var jsonString = JSON.stringify(config).replace(/"/g, '&quot;');
                
                var renderedContent =Â 
                    // Invisible div to store the JSON config
                    '<div data-json-config="' + jsonString + '" style="display:none;"></div>' +
                    
                    // AMPscript to read the config and use it at send time
                    '%%[ ' +
                    'VAR @configJson, @json, @message ' +
                    'SET @configJson = AttributeValue("data-json-config") ' +
                    'SET @json = BuildRowsetFromJson(@configJson, "$", 1) ' +
                    'SET @message = Field(Row(@json, 1), "messageText") ' +
                    ']%%' +
                    
                    // Visible email HTML using the extracted message
                    '<p style="color: blue;">Your custom message: %%=v(@message)=%%</p>';
                    
                sdk.setContent(renderedContent, function () {
                    console.log("Content successfully saved!");
                });
            }

            // 3. LOAD existing content when the editor opens
            sdk.getContent(function (content) {
                if (content) {
                    const config = getConfigFromHtml(content);

                    if (config && config.messageText) {
                        document.getElementById("customMessage").value = config.messageText;
                    } else {
                        console.warn('Content found, but no valid JSON configuration was extracted.');
                    }
                }
            });

            // 4. Attach the Event Listener
            document.getElementById("saveButton").addEventListener("click", saveContent);
        }); // End of DOMContentLoaded
Â  Â  </script>
Â  </body>
</html>

