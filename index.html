<!DOCTYPE html>
<html>
<head>
    <title>Bynder Asset Selector</title>
    
    <script src="https://salesforce-marketingcloud.github.io/blocksdk/dist/blocksdk.min.js"></script>
    
    <script async src="https://ucv.bynder.com/5.0.5/modules/compactview/bynder-compactview-5-latest.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background-color: #f7f7f7; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #bynder-btn {
            background-color: #00A9E0; /* Bynder Blue */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #bynder-btn:hover { background-color: #008cc9; }
        .asset-info { margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px; }
        .asset-info p { margin: 5px 0; font-size: 0.9em; }
        .asset-info strong { color: #333; }
        .placeholder { color: #999; }
    </style>
</head>
<body>
    <div class="card">
        <h3>Bynder Asset Selector</h3>
        <p>Click the button below to browse and select your desired image from the Bynder DAM.</p>
        
        <button id="bynder-btn">Browse Bynder</button>
        
        <div class="asset-info">
            <p><strong>Selected Image:</strong> <span id="asset-name-display" class="placeholder">No asset selected.</span></p>
            <p><strong>Asset ID:</strong> <span id="asset-id-display" class="placeholder">N/A</span></p>
            <p><strong>Alt Text:</strong> <span id="alt-text-display" class="placeholder">N/A</span></p>
        </div>
    </div>

    <script>
        // ðŸš¨ IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR ACTUAL EXTERNAL KEY ðŸš¨
        const BLOCK_EXTERNAL_KEY = '191a42e4-9ec9-4bd0-89a2-5e71df255dfb'; 
        
        // --- Core Initializers ---
        const BYNDER_PORTAL_URL = 'https://accenture-in-global-reseller.bynder.com.bynder.com'; 
        const ALT_TEXT_METAPROPERTY_KEY = 'alt_text'; 
        
        var sdk;
        
        window.onload = function() {
            try {
                // Initialize the SDK
                sdk = new window.sfdc.BlockSDK();
                console.log("SFMC BlockSDK initialized successfully.");
            } catch(e) {
                console.error("CRITICAL ERROR: SDK initialization failed.", e);
                document.getElementById('bynder-btn').disabled = true;
                return;
            }

            // --- 1. Event Listener for Bynder Button ---
            document.getElementById('bynder-btn').addEventListener('click', function() {
                if (typeof BynderCompactView === 'undefined') {
                    alert('Bynder UCV is not yet loaded. Please wait a moment and try again.');
                    return;
                }
                
                BynderCompactView.open({
                    language: "en_US",
                    theme: { colorButtonPrimary: "#3380FF" },
                    mode: "SingleSelectFile",
                    onSuccess: function(assets, additionalInfo) {
                        if (assets && assets.length > 0) {
                            handleAssetSelection(assets[0]);
                        }
                    },
                    onClose: function() { console.log('Bynder UCV closed.'); }
                });
            });


            // --- 2. Load Existing Data on Editor Open (Persistence) ---
            if (sdk) {
                sdk.getData(function (data) {
                    if (data && data.assetID) {
                        console.log("Existing configuration loaded:", data);
                        updateEditorDisplay(data);
                    } else {
                        console.log("No previous configuration data found. Starting fresh.");
                    }
                });
            }
        }; 

        /**
         * Saves data via sdk.setData() and SSJS/AMPscript via sdk.setContent().
         */
        function handleAssetSelection(asset) {
            
            const assetID = asset.id;
            const imageURL = asset.url; 
            let altText = asset.name || "Image"; 
            
            if (asset.metaproperties && asset.metaproperties[ALT_TEXT_METAPROPERTY_KEY]) {
                const metaValue = asset.metaproperties[ALT_TEXT_METAPROPERTY_KEY];
                altText = Array.isArray(metaValue) ? metaValue[0] : metaValue;
            }

            // --- A. CONFIGURATION DATA (for the editor to reload) ---
            const editorConfig = {
                assetID: assetID,
                imageURL: imageURL,
                altText: altText,
                assetName: asset.name 
            };

            // --- B. SERVER-SIDE RENDERING CONTENT (SSJS/AMPscript) ---
            // This content is what gets saved to the block and executes at send time.
            const finalImageHTML = `
%%[
/* 1. Define AMPscript variables */
VAR @imageURL, @altText, @jsonString, @error
]%%
<script runat="server">
    Platform.Load("core", "1.1.1");
    
    // 2. Retrieve the JSON configuration saved by sdk.setData()
    try {
        var blockData = ContentBlockById('${BLOCK_EXTERNAL_KEY}').ContentBlockData;
        var jsonString = blockData.data; 
    } catch(e) {
        var jsonString = null;
        Variable.SetValue("@error", "Retrieval failed. Key: ${BLOCK_EXTERNAL_KEY}. Error: " + e.message);
    }

    if (jsonString) {
        // 3. Parse the JSON string and transfer to AMPscript
        try {
            var data = Platform.Function.ParseJSON(jsonString);

            Platform.Variable.SetValue("@imageURL", data.imageURL);
            Platform.Variable.SetValue("@altText", data.altText);
        } catch(e) {
            Variable.SetValue("@error", "JSON Parse failed. Raw: " + jsonString);
        }
    }
</script>
%%[
/* 4. AMPscript for Conditional Rendering */
IF NOT EMPTY(@imageURL) THEN
]%%
<p style="margin: 0; padding: 0; line-height: 0;">
    <img src="%%=v(@imageURL)=%%" 
         alt="%%=v(@altText)=%%" 
         width="600" 
         style="display:block; max-width:100%; height:auto;" 
         border="0">
</p>
%%[
ELSE
]%%
%%[
ENDIF
]%%
`;

            if (sdk) {
                // 5. Save the Server-Side Rendering code block
                sdk.setContent(finalImageHTML, function() {
                    console.log("SSJS/AMPscript saved for SSR.");
                });
                
                // 6. Save the clean JSON data for the editor to use later
                sdk.setData(editorConfig, function() {
                    console.log("Configuration JSON saved via sdk.setData().");
                    updateEditorDisplay(editorConfig);
                });
            }
        }

        /**
         * Updates the editor's UI fields with the latest data.
         */
        function updateEditorDisplay(data) {
            document.getElementById('asset-name-display').textContent = data.assetName || data.assetID;
            document.getElementById('asset-id-display').textContent = data.assetID;
            document.getElementById('alt-text-display').textContent = data.altText;
            
            document.getElementById('asset-name-display').classList.remove('placeholder');
            document.getElementById('asset-id-display').classList.remove('placeholder');
            document.getElementById('alt-text-display').classList.remove('placeholder');
        }
    </script>
</body>
</html>
