<!DOCTYPE html>
<html>
Â  <head>
Â  Â  <title>Custom Block Editor</title>
Â  Â  <script src="https://unpkg.com/@salesforce-marketingcloud/blocksdk@1.1.2/blocksdk.js"></script>
Â  </head>
Â  <body>
Â  Â  <h1>Custom Message Editor</h1>
Â  Â  <input
Â  Â  Â  type="text"
Â  Â  Â  id="customMessage"
Â  Â  Â  placeholder="Enter your custom message"
Â  Â  />
Â  Â  <button id="saveButton">Save Content</button>

Â  Â  <script>
Â  Â  Â  // 1. Initialize the SDK
Â  Â  Â  var sdk = new window.sfdc.BlockSDK();
Â  Â  Â Â 
Â  Â  Â  // Helper function to safely extract the JSON from the saved HTML
Â  Â  Â  function getConfigFromHtml(html) {
Â  Â  Â  Â  Â  // Use a temporary div to parse the HTML string
Â  Â  Â  Â  Â  const tempDiv = document.createElement('div');
Â  Â  Â  Â  Â  tempDiv.innerHTML = html;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Look for the element with the JSON config data-attribute
Â  Â  Â  Â  Â  // NOTE: This selector targets the element created in saveContent()
Â  Â  Â  Â  Â  const configElement = tempDiv.querySelector('[data-json-config]');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (configElement) {
Â  Â  Â  Â  Â  Â  Â  // Get the string, and replace the escaped &quot; back to " for JSON.parse
Â  Â  Â  Â  Â  Â  Â  const jsonString = configElement.getAttribute('data-json-config').replace(/&quot;/g, '"');
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  return JSON.parse(jsonString);
Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error parsing JSON from saved content:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return null;
Â  Â  Â  }


Â  Â  Â  // 2. Define the saveContent function
Â  Â  Â  function saveContent() {
Â  Â  Â  Â  var message = document.getElementById("customMessage").value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // **SAVE STEP A: Structure the data as JSON**
Â  Â  Â  Â  var config = {
Â  Â  Â  Â  Â  Â  messageText: message
Â  Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  Â  // ðŸ”‘ FIX 1: ESCAPE QUOTES FOR HTML ATTRIBUTE SAFETY
Â  Â  Â  Â  var jsonString = JSON.stringify(config).replace(/"/g, '&quot;');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // **SAVE STEP B: Create the AMPscript/HTML to be saved in the email**
Â  Â  Â  Â  var renderedContent =Â 
Â  Â  Â  Â  Â  Â  // 1. Invisible div to store the JSON config (must be the root of the content)
Â  Â  Â  Â  Â  Â  '<div data-json-config="' + jsonString + '" style="display:none;"></div>' +
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. AMPscript to read the config and use it at send time
Â  Â  Â  Â  Â  Â  // ðŸ’¡ FIX 2: Added VAR declaration for best practice
Â  Â  Â  Â  Â  Â  '%%[ ' +
Â  Â  Â  Â  Â  Â  'VAR @configJson, @json, @message ' +
Â  Â  Â  Â  Â  Â  'SET @configJson = AttributeValue("data-json-config") ' +
Â  Â  Â  Â  Â  Â  'SET @json = BuildRowsetFromJson(@configJson, "$", 1) ' +
Â  Â  Â  Â  Â  Â  'SET @message = Field(Row(@json, 1), "messageText") ' +
Â  Â  Â  Â  Â  Â  ']%%' +
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Visible email HTML using the extracted message
Â  Â  Â  Â  Â  Â  '<p style="color: blue;">Your custom message: %%=v(@message)=%%</p>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  // **SAVE STEP C: Send the final rendered HTML to SFMC**
Â  Â  Â  Â  sdk.setContent(renderedContent, function () {
Â  Â  Â  Â  Â  console.log("Content successfully saved!");
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // 3. **LOAD** existing content when the editor opens
Â  Â  Â  sdk.getContent(function (content) {
Â  Â  Â  Â  if (content) {
Â  Â  Â  Â  Â  Â  // **LOAD STEP A: Extract the JSON from the saved HTML**
Â  Â  Â  Â  Â  Â  const config = getConfigFromHtml(content);

Â  Â  Â  Â  Â  Â  if (config && config.messageText) {
Â  Â  Â  Â  Â  Â  Â  Â  // **LOAD STEP B: Put the extracted message back into the input field**
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("customMessage").value = config.messageText;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Handle cases where content exists but is not valid JSON config
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Content found, but no valid JSON configuration was extracted.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // 4. Attach the Event Listener
Â  Â  Â  document
Â  Â  Â  Â  .getElementById("saveButton")
Â  Â  Â  Â  .addEventListener("click", saveContent);
Â  Â  </script>
Â  </body>
</html>
