<!DOCTYPE html>
<html>
<head>
    <title>Bynder Asset Selector</title>
    
    <!-- External Script for Bynder Compact View (UCV) -->
    <script async src="https://ucv.bynder.com/5.0.5/modules/compactview/bynder-compactview-5-latest.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background-color: #f7f7f7; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #bynder-btn {
            background-color: #00A9E0; /* Bynder Blue */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #bynder-btn:hover { background-color: #008cc9; }
        .asset-info { margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px; }
        .asset-info p { margin: 5px 0; font-size: 0.9em; }
        .asset-info strong { color: #333; }
        .placeholder { color: #999; }
    </style>
</head>
<body>
    <div class="card">
        <h3>Bynder Asset Selector</h3>
        <p>Click the button below to browse and select your desired image from the Bynder DAM.</p>
        
        <button id="bynder-btn">Browse Bynder</button>
        
        <div class="asset-info">
            <p><strong>Selected Image:</strong> <span id="asset-name-display" class="placeholder">No asset selected.</span></p>
            <p><strong>Asset ID:</strong> <span id="asset-id-display" class="placeholder">N/A</span></p>
            <p><strong>Alt Text:</strong> <span id="alt-text-display" class="placeholder">N/A</span></p>
        </div>
        
        <textarea id="alt-text-input" placeholder="Enter Alt Text (Optional)" rows="2" class="w-full mt-4 p-2 border border-gray-300 rounded-lg" style="width: 100%; margin-top: 15px;"></textarea>
        
    </div>

    <script>
        // 🔑 SFMC data structure
        let savedData = {};
        
        window.onload = function() {
            
            // --- 0. Initialize SFMC SDK with Tabs Configuration (Robust Check) ---
            var sdk;
            
            // Check for window.sfdc and window.sfdc.BlockSDK explicitly to prevent TypeError 
            if (typeof window.sfdc !== 'undefined' && typeof window.sfdc.BlockSDK === 'function') {
                try {
                    // Initialize the SFMC Block SDK and configure the tabs
                    sdk = new window.sfdc.BlockSDK({
                        // Set the initial width of the editor panel (optional)
                        blockEditorWidth: 450, 
                        tabs: [
                            { 
                                // The first tab should link back to this editor interface
                                key: 'design', 
                                url: window.location.href, 
                                name: 'Bynder Asset' 
                            }, 
                            'htmlblock',    // Includes the HTML Source Tab
                            'stylingblock'  // Includes the Block Settings (Styling) Tab
                        ]
                    }); 
                    console.log("SFMC BlockSDK initialized successfully with tabs.");
                } catch(e) {
                    // This catches unexpected issues during the constructor call itself
                    console.error("SFMC BlockSDK initialization failed unexpectedly during constructor call.", e);
                    document.getElementById('bynder-btn').disabled = true;
                    return;
                }
            } else {
                // This handles the primary error condition reported by the user
                console.error("CRITICAL ERROR: window.sfdc.BlockSDK is unavailable. Ensure this is running inside SFMC Content Builder.");
                document.getElementById('bynder-btn').disabled = true;
                return;
            }

            // --- 2. Bynder Configuration (Must be updated with correct URL) ---
            const BYNDER_PORTAL_URL = 'https://accenture-in-global-reseller.bynder.com'; // CHECK THIS URL!
            const ALT_TEXT_METAPROPERTY_KEY = 'alt_text';
            
            // ---------------------------------------------------------------------------------
            // --- 3. UCV Launch and Data Handling ---
            // ---------------------------------------------------------------------------------

            document.getElementById('bynder-btn').addEventListener('click', function() {
                if (typeof BynderCompactView === 'undefined') {
                    // Use console.error instead of alert()
                    console.error('Bynder UCV is not yet loaded. Please wait a moment and try again.');
                    return;
                }
                
                BynderCompactView.open({
                    // ⚠️ IMPORTANT: In a real implementation, you may need to pass BYNDER_PORTAL_URL here
                    language: "en_US",
                    theme: {
                        colorButtonPrimary: "#3380FF"
                    },
                    mode: "SingleSelectFile",
                    
                    onSuccess: function(assets, additionalInfo) {
                        if (assets && assets.length > 0) {
                            // Process the selected Bynder asset
                            handleAssetSelection(assets[0]); 
                        }
                    },
                    
                    onClose: function() {
                        console.log('Bynder UCV closed.');
                    }
                });
            });

            // Listener for Alt Text input changes
            document.getElementById('alt-text-input').addEventListener('input', function(event) {
                if (savedData && savedData.assetID) {
                    savedData.altText = event.target.value;
                    // Persist data and re-render HTML for SFMC
                    saveAndUpdateSFMC();
                }
            });


            /**
             * Processes the data returned from the Bynder UCV, updates the savedData object, 
             * and triggers the SFMC save/render process.
             */
            function handleAssetSelection(asset) {
                
                // 1. Get Alt Text from Bynder Metaproperty or Fallback
                let altText = asset.name || "Image"; 
                if (asset.metaproperties && asset.metaproperties[ALT_TEXT_METAPROPERTY_KEY]) {
                    const metaValue = asset.metaproperties[ALT_TEXT_METAPROPERTY_KEY];
                    altText = Array.isArray(metaValue) ? metaValue[0] : metaValue;
                }

                // 2. Build the consistent data object to be saved
                savedData = {
                    assetID: asset.id,
                    assetName: asset.name,
                    imageURL: asset.originalUrl, // Use originalUrl for example, update as needed
                    altText: altText
                };
                
                // 3. Update the UI and save/render to SFMC
                document.getElementById('alt-text-input').value = savedData.altText;
                updateEditorDisplay(savedData);
                saveAndUpdateSFMC();
            }

            /**
             * Persists data using sdk.setData() and renders HTML using sdk.setContent().
             */
            function saveAndUpdateSFMC() {
                // Generate the final HTML for the email content
                const finalImageHTML = '<a href="' + savedData.imageURL + '"><img src="' + savedData.imageURL + '" alt="' + savedData.altText + '" style="width:100%; max-width:600px; display:block;" /></a>';
                
                // 🔑 CRITICAL: Save the configuration data (JSON) so the editor remembers it
                sdk.setData(savedData); 
                console.log("SFMC BlockSDK configuration data set successfully (setData).");

                // 🔑 Set the final HTML content for the email
                sdk.setContent(finalImageHTML);
                console.log("SFMC BlockSDK content set successfully (setContent).");
            }

            /**
             * Updates the editor's UI fields with the latest data.
             */
            function updateEditorDisplay(data) {
                document.getElementById('asset-name-display').textContent = data.assetName || 'N/A';
                document.getElementById('asset-id-display').textContent = data.assetID || 'N/A';
                document.getElementById('alt-text-display').textContent = data.altText || 'N/A';
                
                document.getElementById('asset-name-display').classList.toggle('placeholder', !data.assetName);
                document.getElementById('asset-id-display').classList.toggle('placeholder', !data.assetID);
                document.getElementById('alt-text-display').classList.toggle('placeholder', !data.altText);
            }


            // --- 4. LOAD existing configuration when the editor opens ---
            // This relies on 'sdk' being defined, which is ensured by the robust check above.
            if (sdk) {
                sdk.getData(function (data) {
                    if (data && data.assetID) {
                        console.log("Existing configuration loaded:", data);
                        savedData = data; // Load saved data into the global variable
                        
                        // Populate the display fields and the Alt Text input field
                        updateEditorDisplay(savedData);
                        document.getElementById('alt-text-input').value = savedData.altText || '';
                    } else {
                        console.log("No previous configuration data found. Starting fresh.");
                    }
                });
            }
        }; // End of window.onload
    </script>
</body>
</html>
