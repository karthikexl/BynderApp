<!DOCTYPE html>
<html>
<head>
    <title>Bynder Asset Selector</title>
    
    <script src="https://salesforce-marketingcloud.github.io/blocksdk/dist/blocksdk.min.js"></script>
    
    <script async src="https://ucv.bynder.com/5.0.5/modules/compactview/bynder-compactview-5-latest.js"></script>

    <style>
        /* ... (Your existing CSS here) ... */
    </style>
</head>
<body>
    <div class="card">
        <h3>Bynder Asset Selector</h3>
        <p>Click the button below to browse and select your desired image from the Bynder DAM.</p>
        
        <button id="bynder-btn">Browse Bynder</button>
        
        <div class="asset-info">
            <p><strong>Selected Image:</strong> <span id="asset-name-display" class="placeholder">No asset selected.</span></p>
            <p><strong>Asset ID:</strong> <span id="asset-id-display" class="placeholder">N/A</span></p>
            <p><strong>Alt Text (Fallback):</strong> <span id="alt-text-display" class="placeholder">N/A</span></p>
        </div>
    </div>

    <script>
        // --- 0. Initialize SFMC SDK ---
        // ðŸ”‘ FIX 2: Initialize the modern SDK object
        var sdk;
        try {
            sdk = new window.sfdc.BlockSDK();
        } catch(e) {
            console.error("SFMC BlockSDK initialization failed.", e);
            // Optionally disable the button if SDK fails
            document.getElementById('bynder-btn').disabled = true;
        }

        // --- 2. Bynder Configuration (MUST BE UPDATED) ---
        const BYNDER_PORTAL_URL = 'https://accenture-in-global-reseller.bynder.com.bynder.com'; 
        const ALT_TEXT_METAPROPERTY_KEY = 'alt_text'; 

        // --- 3. UCV Launch and Data Handling ---

        document.getElementById('bynder-btn').addEventListener('click', function() {
            if (typeof BynderCompactView === 'undefined') {
                alert('Bynder UCV is not yet loaded. Please wait a moment and try again.');
                return;
            }
            
            // NOTE: You must also ensure BynderCompactView is configured with your Portal URL!
            // This is often done globally, but ensure your implementation supports the portal
            // or pass it in the options if required by your Bynder integration.
            
            BynderCompactView.open({
                // ... (Your existing UCV options) ...
                onSuccess: function(assets, additionalInfo) {
                    if (assets && assets.length > 0) {
                        handleAssetSelection(assets[0]);
                    }
                },
                // ... (Your existing onClose) ...
            });
        });


        /**
         * Processes the data returned from the Bynder UCV and sends the FINAL HTML to SFMC.
         * @param {Object} asset - The single asset object returned by Bynder.
         */
        function handleAssetSelection(asset) {
            
            // ... (Your existing data extraction logic) ...

            const assetID = asset.id;
            const imageURL = asset.url;
            
            let altText = asset.name || "Default Image Alt Text"; 
            
            if (asset.metaproperties && asset.metaproperties[ALT_TEXT_METAPROPERTY_KEY]) {
                const metaValue = asset.metaproperties[ALT_TEXT_METAPROPERTY_KEY];
                altText = Array.isArray(metaValue) ? metaValue[0] : metaValue;
            }

            // Update the UI for the marketer
            document.getElementById('asset-name-display').textContent = asset.name;
            document.getElementById('asset-id-display').textContent = assetID;
            document.getElementById('alt-text-display').textContent = altText;
            document.getElementById('alt-text-display').classList.remove('placeholder');

            // --- SFMC CONTENT SAVE FUNCTION ---
            if (sdk) {
                // ðŸ”‘ FIX 3: Generate the final HTML/AMPscript using the extracted data
                const finalImageHTML = `
                    <img src="${imageURL}" 
                         alt="${altText}" 
                         width="100%" 
                         style="display:block; max-width:100%; height:auto;" 
                         border="0" />
                    `;

                // Use the modern SDK function to save the final HTML to the block
                sdk.setContent(finalImageHTML, function() {
                    console.log("Bynder Image HTML successfully saved to SFMC Content Block.");
                    // You may also want to use sdk.setData() to save the config JSON for load
                    // sdk.setData({ imageURL: imageURL, altText: altText }, function() { ... });
                });
            } else {
                console.error("SFMC SDK not initialized. Cannot save content.");
            }
        }
    </script>
</body>
</html>
